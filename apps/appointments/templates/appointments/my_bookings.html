{% extends "appointments/base.html" %}

{% block content %}
  <div class="card">
    <h2>Mis reservas</h2>
    <p class="muted">Consulta tus reservas por correo. Puedes filtrar por estado y rango de fechas.</p>
  </div>

  <div class="card">
    <form method="get" class="row" style="gap: 16px; align-items: flex-end;">
      <div style="flex: 2;">
        <label><strong>{{ form.email.label }}</strong></label>
        {{ form.email }}
        {% for err in form.email.errors %}
          <div class="muted" style="color:#b42318;">{{ err }}</div>
        {% endfor %}
      </div>

      <div style="flex: 1;">
        <label><strong>{{ form.status.label }}</strong></label>
        {{ form.status }}
      </div>

      <div style="flex: 1;">
        <label><strong>{{ form.date_from.label }}</strong></label>
        {{ form.date_from }}
      </div>

      <div style="flex: 1;">
        <label><strong>{{ form.date_to.label }}</strong></label>
        {{ form.date_to }}
      </div>

      <div>
        <button class="btn" type="submit">Buscar</button>
      </div>
    </form>
  </div>

  {% if not form.is_bound %}
    <div class="card">
      <p class="muted">Ingresa tu correo y presiona “Buscar”.</p>
    </div>
  {% elif form.errors %}
    <div class="card">
      <p class="muted">Corrige los errores del formulario para ver tus reservas.</p>
    </div>
  {% else %}
    <div class="card">
      <h3>Resultados</h3>

      {% for booking in bookings %}
        <div class="row" style="padding:10px 0; border-bottom:1px solid #eef1f4;">
          <div style="flex: 3;">
            <div><strong>{{ booking.service.name }}</strong></div>
            <div class="muted">Fecha: {{ booking.slot.start_at }}</div>
            <div class="muted">Estado: {{ booking.get_status_display }}</div>
            <div class="muted">Reserva #{{ booking.id }}</div>
          </div>

          <div style="flex: 1; text-align: right;">
            {% if booking.status == "CONFIRMED" %}
              <form method="post" action="{% url 'appointments:booking_cancel' booking.id %}">
                {% csrf_token %}
                <!-- reenviamos email para autorizar cancelación -->
                <input type="hidden" name="email" value="{{ form.cleaned_data.email }}">
                <button class="btn" type="submit">Cancelar</button>
              </form>
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="muted">No encontramos reservas con esos filtros.</p>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <div class="card row" style="justify-content: space-between;">
        <div>
          {% if page_obj.has_previous %}
            <a href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">← Anterior</a>
          {% endif %}
        </div>
        <div class="muted">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </div>
        <div>
          {% if page_obj.has_next %}
            <a href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Siguiente →</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endif %}

{% endblock %}
